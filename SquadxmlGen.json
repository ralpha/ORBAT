{"files":[{"id":"39e84e29-34f2-4f2b-b6a3-8ee7fbb19734","name":"Code","type":"server_js","source":"function createSquadFiles(){\n  for(var i \u003d 0; i \u003c squads.length;i++){\n    Logger.log(\u0027squad:\u0027 + squads[i].name);\n    createSquadFile(squads[i]);\n  }\n}\n\n\n//creat file\nfunction createSquadFile(squad){\n  var files \u003d DriveApp.getFolderById(\"0B8deNilWQGq2cUZTVFBNVjd6SXM\").getFilesByName(squad.squadfile);\n  if(files.hasNext()){\n    files.next().setContent(makeFileContent(squad));\n  }else{\n    DriveApp.getFolderById(\"0B8deNilWQGq2cUZTVFBNVjd6SXM\").createFile(squad.squadfile, makeFileContent(squad), MimeType.PLAIN_TEXT);\n  }\n}\n\nvar squads \u003d [];\nvar ranks \u003d [];\nvar enlisted \u003d [];\nvar CO \u003d [];\n\n\n//start generation\nfunction start(){\n  readJSON();\n  createSquadFiles();\n}\n\nfunction readJSON(){\n  var ranksJson \u003d JSON.parse(UrlFetchApp.fetch(\u0027http://googledrive.com/host/0B8deNilWQGq2a3VUSHlLdldUbFE/Ranks.json\u0027).getContentText());\n  parseRanks(ranksJson);\n  var list \u003d JSON.parse(UrlFetchApp.fetch(\u0027http://googledrive.com/host/0B8deNilWQGq2a3VUSHlLdldUbFE/27thSM.json\u0027).getContentText());\n  parseEnlisted(list);\n  parseSquads(list);\n  squads.push({\n    \"nick\": \"COs\",\n    \"name\": \"Commanding Officers\",\n    \"email\": \"command.27thsm@yahoo.com\",\n    \"web\": \"27thsm.enjin.com\",\n    \"picture\": \"27thSM.paa\",\n    \"title\": \"COs\",\n    \"squadfile\": \"Officers.xml\",\n    \"members\": getMembersInfo(CO)\n  });\n}\n\nfunction parseEnlisted(list){\n  parseMembers(list[3].enlisted);\n}\n\nfunction parseMembers(list){\n  for(var i \u003d 0; i \u003c list.length;i++){\n    parseMember(list[i]);\n  }\n}\n\nfunction parseMember(member){\n  player \u003d {\n    \"ID\": member.ID,\n    \"name\": member.name,\n    \"rank\": member.rank,\n    \"UID\": member.UID,\n    \"remark\": member.remark,\n  }\n  enlisted.push(player);\n}\n\n\nfunction parseSquads(list){\n  parseUnit(list[1]);\n}\n\nfunction parseUnit(unit){\n  if(unit.commander !\u003d \"\" \u0026\u0026 unit.squadfile \u003d\u003d \"\"){\n    var player \u003d getPlayer(unit.commander);\n    if(player !\u003d null){\n      CO.push(player);\n    }\n  }\n  if(unit.squadfile !\u003d \"\" \u0026\u0026 \"squadfile\" in unit){\n    addSquad(unit);\n    for(var j \u003d 0; j \u003c unit.subUnits.length;j++){\n      if(\"subUnits\" in unit.subUnits[j]){\n        parseUnit(unit.subUnits[j]);\n      }\n    }\n  }else{\n    for(var i \u003d 0; i \u003c unit.subUnits.length;i++){\n      if(\"players\" in unit.subUnits[i]){\n        for(var j \u003d 0; j \u003c unit.subUnits[i].players.length;j++){\n          var player \u003d getPlayer(unit.subUnits[i].players[j]);\n          if(player !\u003d null){\n            CO.push(player);\n          }\n        }\n      }else{\n        parseUnit(unit.subUnits[i]);\n      }\n    }\n  }\n}\n\nfunction parseRanks(ranksJson){\n  for(var i \u003d 0; i \u003c ranksJson.Enlisted.length;i++){\n    parseRank(ranksJson.Enlisted[i]);\n  }\n  for(var i \u003d 0; i \u003c ranksJson.CommissionedOfficers.length;i++){\n    parseRank(ranksJson.CommissionedOfficers[i]);\n  }\n  for(var i \u003d 0; i \u003c ranksJson.WarrantOfficers.length;i++){\n    parseRank(ranksJson.WarrantOfficers[i]);\n  }\n}\n\nfunction parseRank(rank){\n  ranks.push({\n    \"title\": rank.title,\n    \"abbreviation\": rank.abbreviation\n  });\n}\n\nfunction addSquad(squad){\n  squad \u003d {\n    \"nick\": squad.name,\n    \"name\": squad.longName,\n    \"email\": \"command.27thsm@yahoo.com\",\n    \"web\": \"27thsm.enjin.com\",\n    \"picture\": (\"\"+ squad.symbol + \".paa\"),//squad.picpaa,\n    \"title\": squad.name,\n    \"squadfile\": squad.squadfile,\n    \"members\": getMembers(squad)\n  }\n  squads.push(squad);\n  \n}\n\nfunction getMembers(squad){\n  var members \u003d [];\n  if(squad.commander !\u003d \"\"){\n    player \u003d getPlayer(squad.commander);\n    if(player !\u003d null){\n      members.push(getMemberInfo(player));\n    }\n  }\n  for(var j \u003d 0; j \u003c squad.subUnits.length;j++){\n    if(\"players\" in squad.subUnits[j]){\n      for(var i \u003d 0; i \u003c squad.subUnits[j].players.length;i++){\n        if(squad.subUnits[j].players[i] !\u003d \"\"){\n          player \u003d getPlayer(squad.subUnits[j].players[i]);\n          if(player !\u003d null){\n            members.push(getMemberInfo(player));\n          }\n        }\n      }\n    }\n  }\n  return members;\n}\n\nfunction getMembersInfo(players){\n  var members \u003d [];\n  Logger.log(\u0027squad:\u0027 + JSON.stringify(players));\n  for(var i \u003d 0; i \u003c players.length ;i++){\n    members.push(getMemberInfo(players[i]));\n  }\n  return members;\n}\n\nfunction getMemberInfo(player){\n  return {\n              \"nick\": makeName({\"name\":player.name,\"rank\":player.rank}),\n              \"name\": player.name,\n              \"email\": \"\",\n              \"icq\": \"\",\n              \"remark\": player.remark,\n              \"id\": player.UID\n            }\n}\n\nfunction makeFileContent(squad){\n  var output \u003d \u0027\u003c?xml version\u003d\"1.0\"?\u003e\u003c!DOCTYPE squad SYSTEM \"squad.dtd\"\u003e\u0027;\n  output +\u003d makeFileContentSquad(squad);\n  return output;\n}\n\nfunction makeFileContentSquad(squad){\n  var output \u003d \u0027\u003csquad nick\u003d\"27thSM, \u0027 + squad.nick +\u0027\"\u003e\u003cname\u003e\u0027+ squad.name +\u0027\u003c/name\u003e\u003cemail\u003e\u0027+ squad.email +\u0027\u003c/email\u003e\u003cweb\u003e\u0027+ squad.web +\u0027\u003c/web\u003e\u003cpicture\u003e\u0027+ squad.picture +\u0027\u003c/picture\u003e\u003ctitle\u003e\u0027+ squad.title +\u0027\u003c/title\u003e\u0027;\n  for(var i \u003d 0; i \u003c squad.members.length;i++){\n    output +\u003d \u0027\u003cmember id\u003d\"\u0027+ squad.members[i].id +\u0027\" nick\u003d\"\u0027+ squad.members[i].nick +\u0027\"\u003e\u003cname\u003e\u0027+ squad.members[i].name +\u0027\u003c/name\u003e\u003cemail\u003e\u0027+ squad.members[i].email + \u0027\u003c/email\u003e\u003cicq\u003e\u0027+ squad.members[i].icq +\u0027\u003c/icq\u003e\u003cremark\u003e\u0027+ squad.members[i].remark +\u0027\u003c/remark\u003e\u003c/member\u003e\u0027;\n  }\n  output +\u003d \u0027\u003c/squad\u003e\u0027;\n  return output;\n}\n\nfunction makeName(player){\n  var name \u003d \"\";\n  name +\u003d getRankAbb(player.rank);\n  name +\u003d player.name;\n  return name;\n}\n\nfunction getRankAbb(rank){\n  for(var i \u003d 0; i \u003c ranks.length;i++){\n    if(ranks[i].title \u003d\u003d rank){\n      return ranks[i].abbreviation;\n    }\n  }\n}\n\nfunction getPlayer(id){\n  for(var i \u003d 0; i \u003c enlisted.length;i++){\n    if(enlisted[i].ID \u003d\u003d id){\n      return enlisted[i];\n    }\n  }\n  return null;\n}\n"}]}